[TOC]

# redis配置

当我们安装好redis之后，可以通过`redis-server`来启动redis服务，redis服务的一些配置包含在redis.conf文件中，如果我们想要修改其中的某些配置可以通过修改该文件来达到目的。

关于redis配置字段的说明在redis.conf文件中有着详细描述。

除此之外还有一些修改配置的方式，我们会一一说明。

### 命令行选项

从2.6版本开始，redis支持在redis-server命令后面添加可选项的方式来修改配置。例如：

```
./redis-server --port 6380 --slaveof 127.0.0.1 6379
```

这个格式只是在指令前面加上了`--`，指令和redis.conf文件中没有任何区别。

### 运行时修改

redis允许在服务启动后修改配置。redis提供的`config set`和`config get`命令来修改和读取当前的配置。但是这种方式并不支持所有的配置选项，只有部分配置可以通过`config set`命令来修改。

值得注意的是使用这种方式来修改redis配置并不会直接修改redis.conf配置文件，如果我们想要将配置同步到redis.conf文件中，我们可以使用`config rewrite`命令。



## 配置缓存

如果你设计的redis中的每个key都有expire time，那么你可以通过设置最大内存的方式来配置缓存：

```
maxmemory 2mb
maxmemory-policy allkeys-lru
```

在这种方式下你无需设置过期时间，当内存使用超过2M后，所有的key都会以LRU算法来进行清除。这种配置下的reids工作方式与memcached类似。

详细信息请参考[文档](https://redis.io/topics/lru-cache)



## 安全配置

接下来我们简单讨论一下redis的安全问题，安全问题不管在什么地方都是很严肃的问题，redis中也不例外。

redis的涉及初衷认为其只在安全环境中使用，也就是无论服务端还是客户端都只在内网环境。但是实际上往往都不是这样的，例如大多数前后端的网络服务都是客户端通常处于外网环境。一般来说，redis优化工作主要在性能和简便这方面，安全并不是其擅长的能力。

虽然redis的安全功能可能不够强大，但是它仍然提供基础的安全配置能力：

- 网络连接
- 防护模式
- 认证功能
- 数据加密
- 禁用指令
- 防止外部客户端触发攻击
- sql注入

### 网络连接配置

redis可以指定个别客户端可以连接到服务，这样的话除了指定的客户端其余的连接请求都会被拒绝。可以通过设置redis.conf文件中的`bing`指令来实现，例如：

```
bind 127.0.0.1
```

同时如果不想其余的主机客户端访问本机服务，可以设置主机防火墙，禁用redis端口。

### 防护模式

大部分redis实例通过公共IP暴露在外网中。因为这个原因，从3.2.0开始，当redis使用默认配置并且没有启用密码认证时，会进入防护模式。在这个模式下只有本地客户端可以正常访问服务，其他地址的客户端访问时都会收到一个错误信息以及如何配置服务端的信息。

当然管理员可以禁用防护模式。(测试后我的redis服务并没有正常弃用防护模式，远端客户端仍然可以访问服务，服务版本4.0.11。猜测和我使用docker启动有关。)

### 认证功能

redis提供一个简单的密码认证功能，可以通过设置redis.conf的`requirepass`指令来开启这个功能。当开启认证功能后，redis会拒绝所有没有经过认证的客户端，客户端可以通过`auth`命令来进行认证。

建议尽量将密码设置稍长一些：

- redis在查询时非常快速，每秒可以尝试多个密码，所以设置长一些增加攻击难度
- redis密码保存在redis.conf文件中，所以对于管理员来说不存在忘记密码的问题，可以随时查看，所以放心的将你的密码设计的反人类些吧

这边需要注意的是`auth`发送密码时不是加密的，所以仍然存在密码被窃听的风险。还有不推荐使用redis-cli -a选项的方式来登录客户端，因为新版的linux系统存在着指令缓存，别人可能通过查看指令日志文件来获取到密码信息。

### 数据加密

redis本身不支持加密，但是可以通过第三方来实现数据加密，例如SSL代理。推荐使用[spiped](http://www.tarsnap.com/spiped.html)。

### 禁用指令

通过禁用指令或者重命名指令来使得客户端无法使用某些危险的指令。例如如果我们给别人提供redis服务但是又不想要使用方可以随意通过`config`命令来修改配置，我们可以将`config`命令重命名为难以猜测的命令，这样使用方就无法通过`config`来修改配置了：

```
rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52
```

当然这个指令仍然在redis.conf文件中进行配置。或者我们可以禁用指令：

```
rename-command CONFIG ""
```

### 防止外部攻击策略

攻击者可能利用系统漏洞通过web表单来对redis进行攻击，不过redis内部通过特殊的算法可以在一定程度上避免这种攻击，但是攻击仍有可能触发。

### SQL注入

redis协议没有字符串转义的概念，所以一般情况下客户端无法进行注入。