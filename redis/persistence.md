[TOC]

# 持久化

redis持久化主要目的是作为一种备份手段以及容灾处理方式，关于redis持久化的特性以及详细信息轻阅读[Redis persistence demystified](http://antirez.com/post/redis-persistence-demystified.html)。

## 持久化方式

redis提供两种不同的持久化方式：

- RDB：在指定的时间间隔内生成时间点快照(point-in-time snapshots)用于记录当前的redis数据状态。
- AOF：会将每条**写操作**记录在指定文件中，当服务器重启时会重读该文件来构建数据集。该文件使用与redis本身协议相同的格式，并且以追加的方式记录，所以该文件会越来越大。

当然你可以禁用redis的持久化，也可以同时使用以上两种持久化方式，如果同时使用两种持久化方式那么redis会先使用AOF来进行数据恢复。

## 优劣势

这两种持久化方式各有其优势以及劣势，下面我们简单分析一下：

### RDB

**优势：**

- RDB文件非常紧凑，它表示了某一时间点redis的数据。因为其文件小，所以非常适合备份。例如可以每天备份一次并且保存近30天内的所有备份文件，这样可以在出现事故时轻松恢复至想要的版本。
- 文件很小，所以可以快速的传输到远程数据中心或者Amazon S3。
- 最大限度提升了redis性能，父进程需要做的唯一工作就是fork一个子进程，子进程会完成持久化的其余工作，父进程永远不会进行I/O操作。
- 当数据量很大时恢复速度会比AOF快。

**劣势：**

- 如果你想要最小程度的保证redis出问题时数据不丢失可能使用RDB不是个好主意。当然你可以通过redis.conf文件的`save`指令来修改保存数据的条件，但是即使你配置5分钟记录一次快照你也可能丢失这5分钟内的数据。
- 每次持久化数据的时候都需要fork一个子进程来进行工作，如果数据集很大并且CPU很紧张的时候，可能导致客户端命令处理长达秒级的延迟。而AOF虽然在重写时也会fork子进程工作，但是我们可以调优重写日志的频率，而无需牺牲持久性。

### AOF

**优势：**

- AOF拥有这更好的持久性，这句话怎么理解呢，这和AOF的持久化策略有关，它的策略我们会在后面具体分析，这边直接给出结论。使用AOF在redis故障时会丢失更短时间内的数据(一般为1s)。
- AOF的日志文件是一个附加日志，它不需要seek，也就是说不会损坏。即使由于某些原因导致命令没有记录完整，也可以通过`redis-check-aof`工具轻松修复。
- 当日志文件过大的时候redis会在后台自动重写日志文件，重写后的日志文件包含恢复当前数据集的最小命令集合。整个操作是绝对安全的，当redis创建新的日志文件的时候，会继续将命令写入现有的AOF文件中，即使重写过程中发生停机，现有的AOF文件也不会丢失。一旦重写完成，redis会从旧日志文件切换到重写后的文件，并且开始对新文件进行追加操作。
- AOF使用易于理解的格式记录每一个写命令，你也可以很方便的导出AOF文件。所以即使你使用`flushall`命令清除了redis数据库，你也可以通过修改AOF文件，删除最后一行`flushall`，然后重启redis进行数据恢复。

**劣势：**

- 对于同样的数据集来说AOF文件一般要比RDB文件大。
- 由于AOF具有不同的策略可能导致其比RDB要慢。
- 某些特定的指令可能导致AOF在恢复数据时出现问题(`brpoplpush`)，但是RDB不会出现这种问题。

你可以根据你的实际情况来选择到底使用何种持久化方式，当时建议同时使用这两种持久化方式。

接下来我们会详细分析一下这两种方式中的一些关键点。

## RDB

### 快照

redis会将快照保存到dump.rdb文件中，你可以通过修改redis.conf文件的`save`指令来指明在n秒内有m个key被改变时记录快照，你也可以手动通过save或者bgsave命令来保存快照。例如：

```
save 60 1000
```

该指令表示如果在60s内如果有1000个key改变就记录快照。关于`save`指令的详细用法可以查阅redis.conf文件中的详细注解。

当redis需要记录快照时，会执行以下步骤：

1. 首先从父进程fork一个子进程
2. 子进程将数据集记录到一个临时的RDB文件中
3. 当记录完成后，替换旧的RDB文件

## AOF

### Append-only file

快照的持久性不是非常好，这句话的意思是如果redis出现故障使用快照可能会丢失相当长一段时间内的数据集。

从redis的1.1版本开始，提供AOF持久策略来提供更为完整的持久性，你可以通过修改redis.conf文件来开启AOF策略：

```
appendonly yes
```

如果你开启了AOF策略，当你重启redis时会使用AOF文件来初始化数据集。

### 日志重写

随着时间的增加AOF文件会变得越来越大因为redis会将每一个写命令都写入日志文件中，即使这些命令可能导致一样的redis数据集结果。

redis提供AOF文件重写功能，它会在后台重写AOF文件并且不会中断客户端命令。在2.2版本中你需要使用`bgrewriteaof`命令来手动重写AOF文件，2.4之后redis会自动执行该工作。

下面我们简单描述一下重写步骤：

1. reids从父进程fork一个子进程
2. 子进程开始将内容重写进一个临时文件
3. 父进程将新收到的命令暂存到内存中，并且同时将命令添加到当前的AOF文件中，所以即使重写失败，我们也不会丢失数据
4. 当重写完成后，父进程会将内存中的命令缀加到新的AOF文件中
5. 使用新的AOF文件替换旧的AOF文件

### AOF持久策略

我们可以通过修改redis.conf文件的`appendfsync`指令来修改AOF的持久策略，这个指令有以下三个值：

- always：redis每收到一条新的写指令就会将其缀加到AOF文件中
- everysec：redis会每秒将内存中的指令缀加到AOF文件中，当然这种策略可能存在丢失1s数据的风险
- no：在这个策略下，何时写AOF文件取决于操作系统。当前liunx会每30s写一次数据，但是具体还得看内核的调度。

建议使用everysec策略，因为它同时保证了速度和安全性。

### AOF截断恢复

AOF文件可能由于某些原因导致记录错误或者中断(在写时服务出现故障或者磁盘占满)，当发生这种情况的时候AOF中最后一个命令可能因为被截断而记录不完整。在这种情况下当我们重启redis加载AOF文件时会发出警告：

```
* Reading RDB preamble from AOF file...
* Reading the remaining AOF tail...
# !!! Warning: short read while loading the AOF file !!!
# !!! Truncating the AOF at offset 439 !!!
# AOF loaded anyway because aof-load-truncated is enabled
```

出现这种错误redis会执行其余所有的命令而忽略最后一个命令，你可以通过配置redis.conf中的`aof-load-truncated`指令来中断数据恢复。

### AOF破坏恢复

有时候AOF文件可能被中间的某些无效字节序列破坏，这时候情况会更加复杂，如果此时重启redis服务，可能得到以下错误提示：

```
* Reading the remaining AOF tail...
# Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix <filename>
```

我们可以通过以下步骤来尝试恢复AOF文件：

1. 在不添加`--fix`选项时执行`redis-check-aof`命令，获取错误信息
2. 根据错误提示定位到AOF文件中的错误点，观察是否可以手动修复错误，如果可以手动修复将之修复
3. 否则只能通过`--fix`选项重新执行`redis-check-aof`命令来修复文件，但是通过这种方式修复文件会丢失问题点之后的所有数据，如果问题出现在文件靠前的位置，后果是难以预料的。

## 运行时RDB转AOF

在此我们只是介绍一下新版本中的方法，老版本请查看下方的连接。

在redis2.2之后的版本中我们可以这样做：

1. 备份dump.rdb文件并将其转储到安全的地方

2. 执行以下两个命令：

   ```
   redis-cli config set appendonly yes
   redis-cli config set save ""
   ```

3. 确保命令执行后数据库中的key数量没有变化

4. 确保写命令会被正确的追加到AOF文件末尾

第二条中的两个命令一个用来开启AOF，一个用来关闭RDB，如果想要下次重启时本次改变仍然生效，需要将当前的配置写入redis.conf文件中。

[老版本做法](https://redis.io/topics/persistence#how-i-can-switch-to-aof-if-i39m-currently-using-dumprdb-snapshots)

## RDB和AOF互斥

在2.4版本之后，`bgsave`命令和`bgrewriteaof`命令不能同时执行，这样可以防止redis同时有两个进程对磁盘进行I/O操作。

如果同时使用RDB和AOF策略时，redis会优先使用AOF策略来恢复数据，因为其数据较为完整。

## 备份redis数据

在阅读这个小节前，先将下面这句话铭记于心：一定要备份你的数据库！

磁盘故障，节点失效等问题都可能让你的数据消失不见，不进行备份是非常危险的。

Redis对于数据备份是非常友好的，因为你可以在服务器运行的时候对 RDB 文件进行复制：RDB 文件一旦被创建就不会进行任何修改。当服务器要创建一个新的 RDB 文件时，它先将文件的内容保存在一个临时文件里面， 当临时文件写入完毕时，程序才使用用临时文件替换原来的RDB 文件。这也就是说无论何时复制 RDB 文件都是绝对安全的。

以下是我们的建议：

- 创建一个定期任务（cron job），每小时将一个 RDB 文件备份到一个文件夹并且每天将一个 RDB 文件备份到另一个文件夹。
- 确保快照的备份都带有相应的日期和时间信息，每次执行定期任务脚本时，使用 `find` 命令来删除过期的快照： 比如说，你可以保留最近 48 小时内的每小时快照，还可以保留最近一两个月的每日快照。
- 至少每天一次将 RDB 备份到你的数据中心之外，或者至少是备份到你运行 Redis 服务器的物理机器之外。

## 容灾备份

Redis 的容灾备份基本上就是对数据进行备份，并将这些备份传送到多个不同的外部数据中心。容灾备份可以在 Redis 运行并产生快照的主数据中心发生严重的问题时，仍然让数据处于安全状态。

因为很多 Redis 用户都是创业者，他们没有大把大把的钱可以浪费，所以下面介绍的都是一些实用又便宜的容债备份方法：

- Amazon S3 以及其他类似 S3 的服务是一个构建灾难备份系统的好地方。 最简单的方法就是将你的每小时或者每日 RDB 备份加密并传送到 S3 。对数据的加密可以通过 `gpg -c` 命令来完成（对称加密模式）。记得把你的密码放到几个不同的安全的地方（比如你可以把密码复制给你组织里最重要的人物），同时可以使用多个储存服务来保存数据文件，这样可以提升数据的安全性。
- 传送快照可以使用 SCP 来完成（SSH 的组件）。以下是简单并且安全的传送方法：买一个离你的数据中心非常远的 VPS ，装上 SSH ，创建一个无口令的 SSH 客户端 key ，并将这个 key 添加到 VPS 的 authorized_keys 文件中，这样就可以向这个 VPS 传送快照备份文件了。为了达到最好的数据安全性，至少要从两个不同的提供商那里各购买一个 VPS 来进行数据容灾备份。

需要注意的是，这类容灾系统如果没有小心地进行处理的话，是很容易失效的。最低限度下，你应该在文件传送完毕之后，检查所传送备份文件的体积和原始快照文件的体积是否相同。如果你使用的是 VPS ，那么还可以通过比对文件的 SHA1 校验和来确认文件是否传送完整。另外， 你还需要一个独立的警报系统， 让它在负责传送备份文件的传送器（transfer）失灵时通知你。